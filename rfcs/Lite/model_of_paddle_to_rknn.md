# 5个Paddle模型部署RK3588设计文档

| 项目| 详情 | 
|---|---|
|提交作者<input type="checkbox" class="rowselector hidden"> | Zheng-Bicheng | 
|提交时间<input type="checkbox" class="rowselector hidden"> | 2022-07-15 | 
|版本号<input type="checkbox" class="rowselector hidden"> | V0.0 | 
|依赖飞桨版本<input type="checkbox" class="rowselector hidden"> | develop | 
|文件名 | model_of_paddle_to_rknn.md<br> | 


# 一、概述
## 1、相关背景
前段时间玩了一下PaddleDetection中的Picodet模型。这个模型在保证正确率的情况下，还能有很高的fps，让我非常惊讶，非常适合于一些小数据集。但是，即使Picodet已经很小了，CPU部署的情况下，我的MBP Pro也只能跑出推理 + 处理每秒20帧（ONNX环境）的成绩。因此，我想参加这个比赛的原因是：此次比赛，一方面能让我获得更好的模型部署经验，另一方面学一下边缘计算的知识也能提升自己，让算法和模型落地。
## 2、功能目标
将指定的5个模型部署到指定的平台上，并出具详细部署指南。并且尽力实现以下要求：
* 实现Paddle模型转ONNX格式
* ONNX模型通过硬件厂商SDK转换为可在硬件上部署的模型文件；
* Python/C++的硬件部署模型代码（包括数据的前后处理）；
* 跑通模型量化，提供清晰的量化指南文档，以及表格数据记录量化带来的精度损失；
* 非量化/量化下的耗时记录。
## 3、意义
于百度和RK而言: 在开发者大会上，百度派了高管来参加，说明百度对RK这家公司还是很重视的。但是，其实百度和RK在AI上的合作并不是很到位。百度对RK的旗舰系列支持度不够（RK3399Pro），在网络上搜到的部署教程寥寥无几。而这次在3588上部署模型算是百度和RK共同迈出的一大步，能弥补百度在这方面的不足，同时也扩大paddlepaddle框架的影响力。

于我自己而言: 如果模型成功部署，将会是我AI学习生涯中不可多得的宝贵经验。同时，我的大学毕业设计也想在RK的平台上做，因此希望能将这次活动带来的宝贵经验运用到其中去。

# 二、飞桨现状
Paddle-Lite对RK的旗舰系列芯片支持度其实不好（可以说是没啥支持度），但是还是可以通过转换成ONNX模型来进行部署的，具有可行性。


# 三、业内方案调研
## RKSDK
### 实现方法
按照以下步骤实现
* PaddlePaddle模型转ONNX模型
* ONNX模型通过RK官方的SDK工具在PC端转换为RKNN模型，中间还可能还有量化的步骤
* 编写Python/C++的硬件部署模型代码（包括数据的前后处理）
* 记录量化带来的精度损失，绘制表格
* 编写文档

# 四、对比分析
由于必须用到RK的SDK，基本上只有以上思路。

# 五、设计思路与实现方案
Paddle 简单部署到 3588 上无非两种情况：
* 如果RK3588支持模型中的全部算子，不出意外应该是能够转换的，功夫要下在模型的量化上。
* 对于部分不支持的算子，我也有自己的解决方案。一开始RK对pytorch的支持也是不够的，对tensorflow的支持度反而更好。去年下半年，我尝试了部署早期的yolov5。通过替换模型中的算子（均为RK3399Pro在当时不支持的算子），在适当降低准确性的影响下，成功将yolov5跑在了RK3399Pro上，提高了yolov5在RK设备上的运行速度。

模型的量化，在开发者大会上，我记得RK提到过好像有3到4种方法，具体需要板子到手以后，根据RK的开发手册，一个一个跑，。
## 底层OP设计
基于RK现有的算子，不单独设计OP。

# 六、测试和验收的考量
这里参考了 [Github--开发板部署任务合集]('https://github.com/PaddlePaddle/Paddle/issues/44068#task80')中的No.80的要求

详细描述：将指定的5个模型部署到指定的平台上，并出具详细部署指南。
必要步骤，奖金根据完成度发放：
完成指定硬件的飞桨模型部署工作，流程包括
* Paddle模型转ONNX格式；
* ONNX模型通过硬件厂商SDK转换为可在硬件上部署的模型文件；
* Python/C++的硬件部署模型代码（包括数据的前后处理）；
* 跑通模型量化，提供清晰的量化指南文档，以及表格数据记录量化带来的精度损失；
* 非量化/量化下的耗时记录。
其中第a步和第b步需要有明确的文档指引流程，参考RK部署指导文档。

第3步根据目前Repo中model_zoo的模型列表进行部署代码开发，在此基础上完成分割或检测，即达到30%的程度，完成所有三种任务模型的适配，即达到60%的程度，完成量化和耗时测试等记录，即达到100%。

# 七、可行性分析和排期规划
五个模型不好定阶段，粗略算了一下，大概还有60-80天的时间，也就是大概12天要完成一个模型的完整部署。
预计的计划如下：
7-8月中旬，完成分割和检测任务的部署。
8-9月初，完成所有三种任务模型的适配
9月，完成量化和耗时测试等记录与各种文档的编写

# 八、影响面
量化对Focus层很不友好，没对齐网络就崩了，有focus层的模型不好部署，可能要删掉focus用其他东西代替了。
# 名词解释
无
# 附件及参考资料
无