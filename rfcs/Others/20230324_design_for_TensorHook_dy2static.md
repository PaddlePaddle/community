# TensorHook 支持动转静

|任务名称 | TensorHook支持动转静                                       | 
|---|-------------------------------------------------------|
|提交作者<input type="checkbox" class="rowselector hidden"> | 约克逊是个郡                                                | 
|提交时间<input type="checkbox" class="rowselector hidden"> | 2023-03-24                                            | 
|版本号 | 此设计文档的版本号，如V1.0                                       | 
|依赖飞桨版本<input type="checkbox" class="rowselector hidden"> | 基于develop版本开发                                | 
|文件名 | 20230324_design_for_TensorHook_dy2static.md | 

# 一、概述
## 1、相关背景
- 动态图下 Tensor 提供了 register_hook 方法，支持用户注册一个hook函数自定义反向grad的数据计算逻辑，此接口仅支持动态图，静态图下缺失对 Tensor 的反向grad同等的逻辑实现，属于动静行为不统一。当用户模型代码包含 register_hook 的用法时，动转静会报错。
## 2、功能目标
- 使得 register_hook 方法在静态图下能正常运行，功能与动态图下一致。
## 3、意义
- 提升飞桨动静行为的统一

# 二、飞桨现状
调研了飞桨目前的框架。
- 目前,在静态图下运行时会将计算的参数转为 Variable 类，因此调用其中的 register_hook 方法运行时会报错。

# 三、业内方案调研
- Tensorflow 在静态图模式下，通过 tf.py_func 来实行修改梯度的操作。

其余的框架:
- pytorch 没有静态图模式。
- MindSpore 中在 nn.Cell 组网过程中可以对梯度缩放的操作，在单独的函数中不知道如何对梯度进行操作。

# 四、对比分析
参考 Tensorflow 的形式，paddle 同样有 py_func 操作，以此作为静态图的 register_hook 的支撑。

# 五、设计思路与实现方案
通过修改 paddle.fluid.jit.framework.Variable 类当中的 register_hook 函数来增加改新功能。

## 1、主体设计思路与折衷
### 整体全貌（可选）
请附上飞桨框架整体架构图，并标明本设计在其中的位置，以及本方案实施后整体框架图的变化，并附对应描述。
### 主体设计具体描述
通过 py_func 添加算子，在不改变代码的情况下。使得静态的反向传播的过程会经过该算子并且被 hook 作用。
### 主体设计选型考量
无

## 2、关键技术点/子模块设计与实现方案
存在的问题:
- 动态图下的 register_hook 返回的是 HookRemoveHelper 类，该部分需要思考是否需要一致。

## 3、主要影响的模块接口变化
### 请列出核心设计对应的直接接口变化
无接口变化
### 请逐一排查对对框架各环节的影响
在其他接口中不会使用到 register_hook，只有外部用户使用，因此不会影响其他功能。 

# 六、测试和验收的考量
在测试用例中不修改代码的情况下能够正常的在静态图下使用 register_hook 功能，且不影响动态图模式。

# 七、影响面
目前看来应该对已有的部分不会有影响，接下去需要看一下开发过程中的过程
## 对用户的影响

## 对二次开发用户的影响
新增的哪些功能和API会暴露给二次开发用户。
## 对框架架构的影响
## 对性能的影响
## 对比业内深度学习框架的差距与优势的影响
## 其他风险

# 八、排期规划
在 4.5 日之前完成开发。

# 名词解释

# 附件及参考资料